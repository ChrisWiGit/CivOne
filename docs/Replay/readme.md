# How Civilization Names Are Determined in Replay

## TL;DR

When generating the replay, civilization names are resolved as follows:

1. The random seed from the save game is used to regenerate the same sequence of civilizations as in the original game. This ensures that civilization names and assignments match the actual playthrough.
2. When a civilization is destroyed, it is removed from the active player list.
3. If a new city is founded and the corresponding civilization ID was previously destroyed, a new civilization is assigned to that ID. The new civilization's name is determined by the next available civilization in the original sequence (sometimes referred to as its "buddy" civilization).

> Civilization names in the replay are not taken directly from the save game data. Instead, they are reconstructed using the original random seed, mirroring the game's own logic.

<!-- https://civilization.fandom.com/wiki/Civilizations_(Civ1) -->

| Color  | Order | Civilization      | Leader         | Capital      |
|--------|-------|------------------|----------------|--------------|
| RED    | 0     | Barbarian (NPC)  | Attila         | N/A          |
| WHITE  | 1     | Romans           | Caesar         | Rome         |
|        |       | Russians         | Stalin         | Moscow       |
| GREEN  | 2     | Babylonians      | Hammurabi      | Babylon      |
|        |       | Zulus            | Shaka          | Zimbabwe     |
| BLUE   | 3     | Germans          | Frederick      | Berlin       |
|        |       | French           | Napoleon       | Paris        |
| YELLOW | 4     | Egyptians        | Ramesses       | Thebes       |
|        |       | Aztecs           | Montezuma      | Tenochtitlan |
| CYAN   | 5     | Americans        | Abe Lincoln    | Washington   |
|        |       | Chinese          | Mao Tse Tung   | Beijing      |
| PINK   | 6     | Greeks           | Alexander      | Athens       |
|        |       | English          | Elizabeth I    | London       |
| GREY   | 7     | Indians          | M. Gandhi      | Delhi        |
|        |       | Mongols          | Genghis Khan   | Samarkand    |
[Civilizations Order ](https://civilization.fandom.com/wiki/Civilizations_(Civ1))

## Testing Results

The question was: How is civilization destruction handled in replay data?
Does it result int duplicated IDs and leader names shown in replay?

**Test scenario**: Destroyed 12 civilizations in two waves using JCivEdit (settlers spawn immediately when cities are captured) and original Civilization.

**Wave 1:**

1. Mongolians
2. Egyptians  
3. Zulus
4. Americans
5. English
6. French

**Wave 2:**

1. Chinese
2. Babylonians
3. Germans
4. Greeks
5. Indians
6. Aztecs

**Result**: Civilization destruction events appeared correctly in REPLAY.TXT.

```text
3980 BC: Mongol civilization destroyed by Romans
3980 BC: Egyptian civilization destroyed by Romans
3980 BC: Zulu civilization destroyed by Romans
3980 BC: American civilization destroyed by Romans
3980 BC: English civilization destroyed by Romans
3980 BC: French civilization destroyed by Romans
3960 BC: Chinese civilization destroyed by Romans
3960 BC: Babylonian civilization destroyed by Romans
3960 BC: German civilization destroyed by Romans
3940 BC: Greek civilization destroyed by Romans
3940 BC: Indian civilization destroyed by Romans
3940 BC: Aztec civilization destroyed by Romans
```

The following output was generated by adding console out in SaveDataAdapter.Get.cs:

```cs
Console.WriteLine($"Civilization destroyed: {bytes[i + 2]} by {bytes[i + 3]} at turn {turn}");
```

```text
Civilization destroyed: 7 by 1 at turn 1
Civilization destroyed: 4 by 1 at turn 1
Civilization destroyed: 2 by 1 at turn 1
Civilization destroyed: 5 by 1 at turn 1
Civilization destroyed: 6 by 1 at turn 1
Civilization destroyed: 3 by 1 at turn 1
Civilization destroyed: 5 by 1 at turn 2
Civilization destroyed: 2 by 1 at turn 2
Civilization destroyed: 3 by 1 at turn 2
Civilization destroyed: 6 by 1 at turn 3
Civilization destroyed: 7 by 1 at turn 3
- Last one missing Aztect, because game cannot be saved after conquesting all civilizations.
```

The following output was generated by adding console output in `MemoryMapReplay.java`:

```java
System.out.println("getPureCivDescription: "+re.getPureCivDescription());
```

(it also writes all the other messages, but these were cut by me.)

```text
getPureCivDescription: 3980 BC: INDIANS ROMANS
getPureCivDescription: 3980 BC: AZTECS ROMANS
getPureCivDescription: 3980 BC: BABYLONIANS ROMANS
getPureCivDescription: 3980 BC: CHINESE ROMANS
getPureCivDescription: 3980 BC: GREEKS ROMANS
getPureCivDescription: 3980 BC: GERMANS ROMANS
getPureCivDescription: 3960 BC: CHINESE ROMANS
getPureCivDescription: 3960 BC: BABYLONIANS ROMANS
getPureCivDescription: 3960 BC: GERMANS ROMANS
getPureCivDescription: 3940 BC: GREEKS ROMANS
getPureCivDescription: 3940 BC: INDIANS ROMANS
```

As you can see, the civilization names are displayed incorrectly, confirming that original civ works differently than CivOne's save game structure may suggest.

## Hex Dump of incoming bytes

`SaveDataAdapter.Get.cs`::`GetReplayData()`  was modified to output the raw bytes of the replay data for debugging:

```cs

byte[] bytes = GetArray(nameof(SaveData.ReplayData), 4096);

for (int i = 0; i < replayLength; i += 8)
{
	Console.WriteLine(string.Join(" ", bytes.Skip(i).Take(8).Select(b => b.ToString("X2"))));
}

```

```text
10 00 01 00 24 13 10 00
02 80 2A 2A 10 00 03 90
21 10 10 00 04 30 29 18
10 00 05 40 0C 12 10 00
06 C0 1F 0E 10 00 07 D0
31 13 90 01 01 D0 31 13
50 01 01 11 D0 01 07 01
10 01 FF 30 29 18 50 01
01 2A D0 01 04 01 10 01
FF 80 2A 2A 50 01 01 21
D0 01 02 01 10 01 FF 40
0C 12 D0 01 05 01 10 01
FF C0 1F 0E D0 01 06 01
10 01 FF 90 21 10 D0 01
03 01 10 01 02 10 47 08
10 01 03 20 10 1D 10 01
05 B0 08 0F 10 02 FF B0
08 0F D0 02 05 01 10 02
FF 10 47 08 D0 02 02 01
10 02 FF 20 10 1D D0 02
03 01 10 02 04 A0 3B 18
10 02 06 50 0C 0E 10 02
07 60 31 0A 10 03 FF D0
31 13 10 03 FF 50 0C 0E
D0 03 06 01 10 03 FF 60
31 0A D0 03 07 01 00 00
```

Dec: 208 = 0xD0

```text
i = 52, byte[i]=208, byte[i+1]=1, byte[i+2]=7, byte[i+3]=1
Civilization destroyed: 7 by 1 at turn 1
i = 66, byte[i]=208, byte[i+1]=1, byte[i+2]=4, byte[i+3]=1
Civilization destroyed: 4 by 1 at turn 1
i = 80, byte[i]=208, byte[i+1]=1, byte[i+2]=2, byte[i+3]=1
Civilization destroyed: 2 by 1 at turn 1
i = 90, byte[i]=208, byte[i+1]=1, byte[i+2]=5, byte[i+3]=1
Civilization destroyed: 5 by 1 at turn 1
i = 100, byte[i]=208, byte[i+1]=1, byte[i+2]=6, byte[i+3]=1
Civilization destroyed: 6 by 1 at turn 1
i = 110, byte[i]=208, byte[i+1]=1, byte[i+2]=3, byte[i+3]=1
Civilization destroyed: 3 by 1 at turn 1
i = 138, byte[i]=208, byte[i+1]=2, byte[i+2]=5, byte[i+3]=1
Civilization destroyed: 5 by 1 at turn 2
i = 148, byte[i]=208, byte[i+1]=2, byte[i+2]=2, byte[i+3]=1
Civilization destroyed: 2 by 1 at turn 2
i = 158, byte[i]=208, byte[i+1]=2, byte[i+2]=3, byte[i+3]=1
Civilization destroyed: 3 by 1 at turn 2
i = 192, byte[i]=208, byte[i+1]=3, byte[i+2]=6, byte[i+3]=1
Civilization destroyed: 6 by 1 at turn 3
i = 202, byte[i]=208, byte[i+1]=3, byte[i+2]=7, byte[i+3]=1
Civilization destroyed: 7 by 1 at turn 3

```

```text
City built: Owner 1, City 0 at (36,19) turn 0
City built: Owner 2, City 128 at (42,42) turn 0
City built: Owner 3, City 144 at (33,16) turn 0
City built: Owner 4, City 48 at (41,24) turn 0
City built: Owner 5, City 64 at (12,18) turn 0
City built: Owner 6, City 192 at (31,14) turn 0
City built: Owner 7, City 208 at (49,19) turn 0
City captured: Civ 1, City 208 at (49,19) turn 1
Advance discovered: Civ 1, Advance 17 at turn 1
Civilization destroyed: 7 by 1 at turn 1
City destroyed: City 48 at (41,24) turn 1
Advance discovered: Civ 1, Advance 42 at turn 1
Civilization destroyed: 4 by 1 at turn 1
City destroyed: City 128 at (42,42) turn 1
Advance discovered: Civ 1, Advance 33 at turn 1
Civilization destroyed: 2 by 1 at turn 1
City destroyed: City 64 at (12,18) turn 1
Civilization destroyed: 5 by 1 at turn 1
City destroyed: City 192 at (31,14) turn 1
Civilization destroyed: 6 by 1 at turn 1
City destroyed: City 144 at (33,16) turn 1
Civilization destroyed: 3 by 1 at turn 1
City built: Owner 2, City 16 at (71,8) turn 1
City built: Owner 3, City 32 at (16,29) turn 1
City built: Owner 5, City 176 at (8,15) turn 1
City destroyed: City 176 at (8,15) turn 2
Civilization destroyed: 5 by 1 at turn 2
City destroyed: City 16 at (71,8) turn 2
Civilization destroyed: 2 by 1 at turn 2
City destroyed: City 32 at (16,29) turn 2
Civilization destroyed: 3 by 1 at turn 2
City built: Owner 4, City 160 at (59,24) turn 2
City built: Owner 6, City 80 at (12,14) turn 2
City built: Owner 7, City 96 at (49,10) turn 2
City destroyed: City 208 at (49,19) turn 3
City destroyed: City 80 at (12,14) turn 3
Civilization destroyed: 6 by 1 at turn 3
City destroyed: City 96 at (49,10) turn 3
Civilization destroyed: 7 by 1 at turn 3
```

**Sequence of Events**:

1. **Turn 1**: Zulus (ID=2) destroyed: `D0 01 02 01`, and `10 02 FF` City of Zulus destroyed.
2. **Turn 2**: Babylonians spawns: `10 01 02 10 47 08` (City Built event: 10 >> 4 = 1, turn=01, OwnerId=02, City data: name=10 x=47 y=08)

